<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a1a">
<title>Pokladna ‚Äî Palety V√≠t</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#1a1a1a; --bg2:#222222; --bg3:#2a2a2a; --bg4:#333333;
  --border:#3a3a3a; --white:#f0f0f0; --dim:#888; --muted:#444;
  --official:#4a9eff; --official-bg:#0d1f35; --official-dim:#1a3a5c;
  --unofficial:#ff6b35; --unofficial-bg:#2a1208; --unofficial-dim:#4a2010;
  --green:#5dbb6a; --red:#e05555; --yellow:#f0b429;
  --hh:58px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{background:var(--bg);color:var(--white);font-family:'Barlow',sans-serif;min-height:100vh;max-width:480px;margin:0 auto;padding-bottom:90px;touch-action:manipulation}

/* HEADER */
.header{height:var(--hh);background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;flex-direction:column;line-height:1}
.logo-top,.logo-bot{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;letter-spacing:6px;text-transform:uppercase;color:var(--white)}
.logo-bot{display:flex;gap:14px}
.logo-sep{height:1px;background:rgba(255,255,255,.12);margin:2px 0}
.hdate{text-align:right;font-size:11px;color:var(--dim);line-height:1.6}

/* BALANCE CARDS */
.balance-wrap{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.bcard{border-radius:12px;padding:14px;border:1px solid}
.bcard.official{background:var(--official-bg);border-color:var(--official-dim)}
.bcard.unofficial{background:var(--unofficial-bg);border-color:var(--unofficial-dim)}
.bcard-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.bcard.official .bcard-lbl{color:var(--official)}
.bcard.unofficial .bcard-lbl{color:var(--unofficial)}
.bcard-amt{font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;line-height:1}
.bcard.official .bcard-amt{color:var(--official)}
.bcard.unofficial .bcard-amt{color:var(--unofficial)}
.bcard-sub{font-size:10px;color:var(--dim);margin-top:4px}

/* TODAY STRIP */
.today-strip{margin:0 12px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
.today-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--dim)}
.today-vals{display:flex;gap:16px}
.today-item{text-align:right}
.today-item-lbl{font-size:10px;color:var(--dim)}
.today-item-val{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800}
.today-item-val.plus{color:var(--green)}
.today-item-val.minus{color:var(--red)}

/* SECTION LABEL */
.sec-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2.5px;text-transform:uppercase;color:var(--dim);padding:8px 12px 4px}

/* TRANSACTION LIST */
.txlist{padding:0 12px;display:flex;flex-direction:column;gap:6px}
.txitem{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;display:flex;align-items:center;gap:10px}
.txitem-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.txitem-icon.income{background:#1a3a1a}
.txitem-icon.expense{background:#2a1a1a}
.txitem-info{flex:1;min-width:0}
.txitem-cat{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txitem-meta{font-size:11px;color:var(--dim);margin-top:1px}
.txitem-right{text-align:right;flex-shrink:0}
.txitem-amt{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800}
.txitem-amt.plus{color:var(--green)}
.txitem-amt.minus{color:var(--red)}
.txitem-kasa{font-size:10px;margin-top:2px;font-weight:700;letter-spacing:1px}
.txitem-kasa.official{color:var(--official)}
.txitem-kasa.unofficial{color:var(--unofficial)}
.empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:14px}

/* BOTTOM BAR */
.bbar{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--bg2);border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:8px;z-index:100}
.btn{padding:13px;border:none;border-radius:9px;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .12s}
.bico{background:var(--bg3);color:var(--dim);border:1px solid var(--border);width:50px;font-size:18px;flex-shrink:0}
.bico:active{background:var(--border)}
.badd{flex:1;background:var(--white);color:#1a1a1a;font-size:16px}
.badd:active{background:#ccc;transform:scale(.98)}

/* OVERLAY */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:flex-end;justify-content:center}
.ov.open{display:flex}
.modal{background:var(--bg2);border-top:2px solid var(--border);border-radius:16px 16px 0 0;width:100%;max-width:480px;padding:20px 16px 40px;max-height:92vh;overflow-y:auto}
.mhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.mtit{font-family:'Barlow Condensed',sans-serif;font-size:19px;font-weight:800;letter-spacing:1px;text-transform:uppercase}
.mclose{background:none;border:none;color:var(--dim);font-size:22px;cursor:pointer;padding:2px 4px}

/* FORM */
.fgrp{margin-bottom:14px}
.flbl{display:block;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:6px}
.finp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--white);font-family:'Barlow',sans-serif;font-size:16px;padding:12px 14px;outline:none;transition:border-color .12s;-moz-appearance:textfield}
.finp::-webkit-outer-spin-button,.finp::-webkit-inner-spin-button{-webkit-appearance:none}
.finp:focus{border-color:var(--white)}
.finp::placeholder{color:var(--muted)}

.seg{display:flex;gap:6px}
.seg-btn{flex:1;padding:11px 6px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--dim);cursor:pointer;text-align:center;transition:all .12s}
.seg-btn.on-income{background:#1a3a1a;color:var(--green);border-color:var(--green)}
.seg-btn.on-expense{background:#2a1a1a;color:var(--red);border-color:var(--red)}
.seg-btn.on-official{background:var(--official-bg);color:var(--official);border-color:var(--official)}
.seg-btn.on-unofficial{background:var(--unofficial-bg);color:var(--unofficial);border-color:var(--unofficial)}
.seg-btn.on-person{background:var(--bg4);color:var(--white);border-color:var(--white)}

.cats{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px}
.cat-btn{padding:10px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:var(--dim);cursor:pointer;text-align:center;transition:all .12s}
.cat-btn.on{background:var(--bg4);color:var(--white);border-color:var(--white)}

.bok{width:100%;padding:15px;background:var(--white);color:#1a1a1a;border:none;border-radius:9px;font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:800;letter-spacing:1px;text-transform:uppercase;cursor:pointer;margin-top:4px}
.bok:active{opacity:.85}
.bok:disabled{background:var(--border);color:var(--muted);cursor:not-allowed}

/* STATS SCREEN */
.screen{display:none;position:fixed;inset:0;background:var(--bg);z-index:150;overflow-y:auto;padding-bottom:90px}
.screen.open{display:block}
.screen-hd{height:var(--hh);background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
.screen-tit{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:4px;text-transform:uppercase}
.sclose{background:none;border:none;color:var(--dim);font-size:22px;cursor:pointer;padding:4px 8px}

.ptabs{display:flex;gap:6px;padding:14px 12px 4px}
.ptab{flex:1;padding:9px 4px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--dim);cursor:pointer;text-align:center;transition:all .12s}
.ptab.on{background:var(--white);color:#1a1a1a;border-color:var(--white)}

.scards{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px 12px}
.sc{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 12px}
.sc.wide{grid-column:1/-1}
.sclbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:6px}
.scval{font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;line-height:1}
.scsub{font-size:11px;color:var(--dim);margin-top:4px}

.catlist{padding:0 12px;display:flex;flex-direction:column;gap:6px;margin-top:4px}
.catrow{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:8px}
.catrow-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;min-width:110px}
.catrow-bar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.catrow-fill{height:100%;background:var(--white);border-radius:2px}
.catrow-amt{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;min-width:70px;text-align:right}

/* TOAST */
.toast{position:fixed;top:66px;left:50%;transform:translateX(-50%);background:var(--green);color:#0a1a0a;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;letter-spacing:1px;padding:11px 22px;border-radius:8px;z-index:300;opacity:0;transition:opacity .25s;white-space:nowrap;pointer-events:none}
.toast.on{opacity:1}

/* HISTORY SCREEN */
.hlist{display:flex;flex-direction:column;gap:7px;padding:10px 12px}
.hitem{background:var(--bg3);border-radius:8px;padding:11px 13px;border-left:3px solid var(--border)}
.hitem.income{border-left-color:var(--green)}
.hitem.expense{border-left-color:var(--red)}
.hhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.hdate2{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:var(--dim)}
.hamt{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800}
.hamt.plus{color:var(--green)}
.hamt.minus{color:var(--red)}
.hdet2{font-size:11px;color:var(--dim);line-height:1.6}
.hnote2{font-size:11px;color:var(--dim);font-style:italic;margin-top:3px}
.hact{display:flex;gap:6px;margin-top:8px}
.hbtn{flex:1;padding:7px;border:none;border-radius:7px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer}
.hbtn-del{background:#2a1a1a;color:var(--red);border:1px solid #4a2a2a}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:14px">
    <div style="display:flex;flex-direction:column;line-height:1">
      <div style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;letter-spacing:5px;color:var(--white)">PALETY</div>
      <div style="display:flex;gap:10px;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;letter-spacing:5px;color:var(--white)"><span>V√ç</span><span>T</span></div>
    </div>
    <div style="width:1px;height:32px;background:var(--border)"></div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:18px;letter-spacing:4px;text-transform:uppercase;color:var(--dim)">POKLADNA</div>
  </div>
  <div class="hdate" id="hdate"></div>
</div>

<div class="balance-wrap">
  <div class="bcard" style="grid-column:1/-1;background:#1a2a1a;border-color:#2a4a2a">
    <div class="bcard-lbl" style="color:var(--green)">Celkov√Ω z≈Østatek</div>
    <div class="bcard-amt" id="bal-total" style="color:var(--green)">0 Kƒç</div>
    <div class="bcard-sub">p≈ô√≠jmy ‚àí v√Ωdaje</div>
  </div>
  <div class="bcard official">
    <div class="bcard-lbl">V√Ωdaje ofiko</div>
    <div class="bcard-amt" id="bal-official">0 Kƒç</div>
    <div class="bcard-sub" id="bal-official-sub">utraceno z ofiko</div>
  </div>
  <div class="bcard unofficial">
    <div class="bcard-lbl">V√Ωdaje neofiko</div>
    <div class="bcard-amt" id="bal-unofficial">0 Kƒç</div>
    <div class="bcard-sub" id="bal-unofficial-sub">utraceno z neofiko</div>
  </div>
</div>

<div class="today-strip">
  <div class="today-lbl">Dnes</div>
  <div class="today-vals">
    <div class="today-item">
      <div class="today-item-lbl">P≈ô√≠jmy</div>
      <div class="today-item-val plus" id="today-in">0 Kƒç</div>
    </div>
    <div class="today-item">
      <div class="today-item-lbl">V√Ωdaje</div>
      <div class="today-item-val minus" id="today-out">0 Kƒç</div>
    </div>
  </div>
</div>

<div class="sec-lbl">Posledn√≠ transakce</div>
<div class="txlist" id="txlist"></div>

<div class="bbar">
  <button class="btn bico" onclick="openHistory()">‚ò∞</button>
  <button class="btn badd" onclick="openAdd()">+ P≈ôidat transakci</button>
  <button class="btn bico" onclick="openStats()">üìä</button>
</div>

<!-- ADD MODAL -->
<div class="ov" id="ov-add">
  <div class="modal">
    <div class="mhd"><div class="mtit">Nov√° transakce</div><button class="mclose" onclick="closeOv('ov-add')">‚úï</button></div>

    <div class="fgrp">
      <label class="flbl">Typ</label>
      <div class="seg">
        <button class="seg-btn on-income" id="typ-income" onclick="setTyp('income')">‚Üë P≈ô√≠jem</button>
        <button class="seg-btn" id="typ-expense" onclick="setTyp('expense')">‚Üì V√Ωdaj</button>
      </div>
    </div>

    <div class="fgrp" id="fgrp-kasa">
      <label class="flbl">Kasa</label>
      <div class="seg">
        <button class="seg-btn on-official" id="kas-official" onclick="setKasa('official')">üîµ Ofici√°ln√≠</button>
        <button class="seg-btn" id="kas-unofficial" onclick="setKasa('unofficial')">üî¥ Neofici√°ln√≠</button>
      </div>
    </div>

    <div class="fgrp">
      <label class="flbl">Kdo</label>
      <div class="seg">
        <button class="seg-btn on-person" id="per-lukas" onclick="setPerson('Luk√°≈°')">Luk√°≈°</button>
        <button class="seg-btn" id="per-kolega" onclick="setPerson('Ondra')">Ondra</button>
      </div>
    </div>

    <div class="fgrp">
      <label class="flbl">Kategorie</label>
      <div class="cats" id="cats"></div>
    </div>

    <div class="fgrp">
      <label class="flbl">ƒå√°stka (Kƒç)</label>
      <input class="finp" type="number" id="finp-amt" placeholder="0" inputmode="numeric" min="0" oninput="validateForm()">
    </div>

    <div class="fgrp">
      <label class="flbl">Pozn√°mka</label>
      <input class="finp" type="text" id="finp-note" placeholder="Nepovinn√° pozn√°mka‚Ä¶" maxlength="120">
    </div>

    <button class="bok" id="bok-add" onclick="saveTx()" disabled>‚úì Ulo≈æit transakci</button>
  </div>
</div>

<!-- HISTORY SCREEN -->
<div class="screen" id="screen-history">
  <div class="screen-hd">
    <div class="screen-tit">Historie</div>
    <button class="sclose" onclick="closeScreen('screen-history')">‚úï</button>
  </div>
  <div class="hlist" id="hlist"></div>
</div>

<!-- STATS SCREEN -->
<div class="screen" id="screen-stats">
  <div class="screen-hd">
    <div class="screen-tit">Statistiky</div>
    <button class="sclose" onclick="closeScreen('screen-stats')">‚úï</button>
  </div>
  <div class="ptabs">
    <button class="ptab on" onclick="setPeriod(0,this)">Dnes</button>
    <button class="ptab" onclick="setPeriod(7,this)">7 dn√≠</button>
    <button class="ptab" onclick="setPeriod(30,this)">30 dn√≠</button>
  </div>
  <div class="scards" id="scards"></div>
  <div class="sec-lbl" style="padding-top:14px">V√Ωdaje podle kategorie</div>
  <div class="catlist" id="catlist"></div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD60m7hSErvSuOQul3kfAjWPpGfVmyVVuM",
  authDomain: "vykup-palet.firebaseapp.com",
  projectId: "vykup-palet",
  storageBucket: "vykup-palet.firebasestorage.app",
  messagingSenderId: "264591837143",
  appId: "1:264591837143:web:5bd414b54a33a3fde26d92"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const q = query(collection(db, "pokladna"), orderBy("ts", "desc"));
onSnapshot(q, (snapshot) => {
  const data = [];
  snapshot.forEach(d => data.push({...d.data(), _id: d.id}));
  window._txData = data;
  localStorage.setItem('pk_hist', JSON.stringify(data));
  refreshAll();
});

window.saveToFirebase = async function(rec) {
  try {
    await addDoc(collection(db, "pokladna"), rec);
    return true;
  } catch(e) { console.error(e); return false; }
};

window.deleteFromFirebase = async function(id) {
  try {
    await deleteDoc(doc(db, "pokladna", id));
    return true;
  } catch(e) { console.error(e); return false; }
};
</script>

<script>
const CATS_EXPENSE = ['V√Ωkup palet','Mzda','Z√°loha na mzdu','Doprava','Nafta','Materi√°l','Jin√Ω v√Ωdaj'];
const CATS_INCOME  = ['Vklad','Maloprodej','Platba FA cash','Jin√Ω p≈ô√≠jem'];

const fd = d => (d?new Date(d):new Date()).toLocaleDateString('cs-CZ',{day:'2-digit',month:'2-digit',year:'numeric'});
const ft = d => (d?new Date(d):new Date()).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});
const fkc = n => n.toLocaleString('cs-CZ') + ' Kƒç';

const ck = () => document.getElementById('hdate').innerHTML = `<div>${fd()}</div><div>${ft()}</div>`;
ck(); setInterval(ck, 30000);

let formTyp = 'income', formKasa = 'official', formPerson = 'Luk√°≈°', formCat = '';

function gh() {
  if (window._txData) return window._txData;
  try { return JSON.parse(localStorage.getItem('pk_hist') || '[]'); } catch(e) { return []; }
}

function refreshAll() {
  renderBalances();
  renderToday();
  renderRecent();
  if (document.getElementById('screen-stats').classList.contains('open')) renderStats();
  if (document.getElementById('screen-history').classList.contains('open')) renderHistory();
}

function renderBalances() {
  const h = gh();
  let totalInc = 0, offExp = 0, unoffExp = 0;
  h.forEach(t => {
    if (t.typ === 'income') totalInc += t.amt;
    else if (t.kasa === 'official') offExp += t.amt;
    else unoffExp += t.amt;
  });
  const offBal = totalInc - offExp - unoffExp; // celkov√Ω z≈Østatek
  document.getElementById('bal-official').textContent = fkc(offExp);
  document.getElementById('bal-unofficial').textContent = fkc(unoffExp);
  document.getElementById('bal-official').style.color = 'var(--official)';
  document.getElementById('bal-unofficial').style.color = 'var(--unofficial)';
  // Update labels
  document.getElementById('bal-official-sub').textContent = 'utraceno z ofiko';
  document.getElementById('bal-unofficial-sub').textContent = 'utraceno z neofiko';
  // Total balance card
  const tb = document.getElementById('bal-total');
  if (tb) { tb.textContent = fkc(totalInc - offExp - unoffExp); tb.style.color = (totalInc-offExp-unoffExp)>=0?'var(--green)':'var(--red)'; }
}

function renderToday() {
  const h = gh();
  const today = new Date(); today.setHours(0,0,0,0);
  const todayTx = h.filter(t => new Date(t.ts) >= today);
  const inc = todayTx.filter(t => t.typ === 'income').reduce((s,t) => s+t.amt, 0);
  const exp = todayTx.filter(t => t.typ === 'expense').reduce((s,t) => s+t.amt, 0);
  document.getElementById('today-in').textContent = fkc(inc);
  document.getElementById('today-out').textContent = fkc(exp);
}

function renderRecent() {
  const h = gh().slice(0, 10);
  const el = document.getElementById('txlist');
  if (h.length === 0) { el.innerHTML = '<div class="empty">≈Ω√°dn√© transakce zat√≠m.</div>'; return; }
  el.innerHTML = h.map(t => txHTML(t)).join('');
}

function txHTML(t) {
  const icon = t.typ === 'income' ? '‚Üë' : '‚Üì';
  const iconCls = t.typ === 'income' ? 'income' : 'expense';
  const amtCls = t.typ === 'income' ? 'plus' : 'minus';
  const sign = t.typ === 'income' ? '+' : '‚àí';
  const kasaCls = t.kasa === 'official' ? 'official' : 'unofficial';
  const kasaLbl = t.kasa === 'official' ? 'OFICI√ÅLN√ç' : 'NEOFICI√ÅLN√ç';
  return `<div class="txitem">
    <div class="txitem-icon ${iconCls}">${icon}</div>
    <div class="txitem-info">
      <div class="txitem-cat">${t.cat}</div>
      <div class="txitem-meta">${t.date} ${t.time} ¬∑ ${t.person}</div>
    </div>
    <div class="txitem-right">
      <div class="txitem-amt ${amtCls}">${sign}${fkc(t.amt)}</div>
      <div class="txitem-kasa ${kasaCls}">${kasaLbl}</div>
    </div>
  </div>`;
}

// FORM
function setTyp(v) {
  formTyp = v; formCat = '';
  document.getElementById('typ-income').className = 'seg-btn' + (v==='income'?' on-income':'');
  document.getElementById('typ-expense').className = 'seg-btn' + (v==='expense'?' on-expense':'');
  // Skr√Ωt/zobrazit kasa selector
  document.getElementById('fgrp-kasa').style.display = v==='income' ? 'none' : '';
  if (v==='income') formKasa = 'none';
  else formKasa = 'official';
  if (v==='expense') {
    document.getElementById('kas-official').className='seg-btn on-official';
    document.getElementById('kas-unofficial').className='seg-btn';
  }
  renderCats();
  validateForm();
}

function setKasa(v) {
  formKasa = v;
  document.getElementById('kas-official').className = 'seg-btn' + (v==='official'?' on-official':'');
  document.getElementById('kas-unofficial').className = 'seg-btn' + (v==='unofficial'?' on-unofficial':'');
}

function setPerson(v) {
  formPerson = v;
  document.getElementById('per-lukas').className = 'seg-btn' + (v==='Luk√°≈°'?' on-person':'');
  document.getElementById('per-kolega').className = 'seg-btn' + (v==='Ondra'?' on-person':'');
}

function setCat(v) {
  formCat = v;
  document.querySelectorAll('.cat-btn').forEach(b => b.className = 'cat-btn' + (b.dataset.cat===v?' on':''));
  validateForm();
}

function renderCats() {
  const cats = formTyp === 'income' ? CATS_INCOME : CATS_EXPENSE;
  document.getElementById('cats').innerHTML = cats.map(c =>
    `<button class="cat-btn${formCat===c?' on':''}" data-cat="${c}" onclick="setCat('${c}')">${c}</button>`
  ).join('');
}

function validateForm() {
  const amt = parseFloat(document.getElementById('finp-amt').value);
  document.getElementById('bok-add').disabled = !(formCat && amt > 0);
}

function openAdd() {
  formTyp='income'; formKasa='official'; formPerson='Luk√°≈°'; formCat='';
  document.getElementById('typ-income').className='seg-btn on-income';
  document.getElementById('typ-expense').className='seg-btn';
  document.getElementById('kas-official').className='seg-btn on-official';
  document.getElementById('fgrp-kasa').style.display='none';
  formKasa='none';
  document.getElementById('kas-unofficial').className='seg-btn';
  document.getElementById('per-lukas').className='seg-btn on-person';
  document.getElementById('per-kolega').className='seg-btn';
  document.getElementById('finp-amt').value='';
  document.getElementById('finp-note').value='';
  document.getElementById('bok-add').disabled=true;
  renderCats();
  document.getElementById('ov-add').classList.add('open');
}

async function saveTx() {
  const amt = parseFloat(document.getElementById('finp-amt').value);
  const note = (document.getElementById('finp-note').value||'').trim();
  if (!formCat || !amt) return;
  const now = new Date();
  const rec = {ts:now.toISOString(), date:fd(now), time:ft(now), typ:formTyp, kasa:formKasa, person:formPerson, cat:formCat, amt, note};
  document.getElementById('bok-add').disabled = true;
  if (window.saveToFirebase) await window.saveToFirebase(rec);
  else {
    const h = gh(); h.unshift(rec); localStorage.setItem('pk_hist', JSON.stringify(h.slice(0,500)));
    refreshAll();
  }
  // Z√°pis do Google Sheets
  const encoded = encodeURIComponent(JSON.stringify(rec));
  const img = new Image();
  img.src = 'https://script.google.com/macros/s/AKfycbxKhJnWxpNA5XrqOCWyOGIJK2MTG90htjPVCtJe5iUiaqS6f7ZTLMilX_gmJtV0qZll0g/exec?data=' + encoded;
  closeOv('ov-add');
  toast('‚úì Transakce ulo≈æena');
}

function closeOv(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.ov').forEach(el => el.addEventListener('click', e => { if(e.target===el) el.classList.remove('open'); }));

function openHistory() { renderHistory(); document.getElementById('screen-history').classList.add('open'); }
function closeScreen(id) { document.getElementById(id).classList.remove('open'); }

function renderHistory() {
  const h = gh();
  const el = document.getElementById('hlist');
  if (h.length === 0) { el.innerHTML = '<div class="empty">≈Ω√°dn√© transakce zat√≠m.</div>'; return; }
  el.innerHTML = h.map((t,i) => {
    const amtCls = t.typ==='income'?'plus':'minus';
    const sign = t.typ==='income'?'+':'‚àí';
    const kasaCls = t.kasa==='official'?'official':'unofficial';
    const kasaLbl = t.kasa==='official'?'OFICI√ÅLN√ç':'NEOFICI√ÅLN√ç';
    return `<div class="hitem ${t.typ}">
      <div class="hhd">
        <div class="hdate2">${t.date} ${t.time} ¬∑ ${t.person}</div>
        <div class="hamt ${amtCls}">${sign}${fkc(t.amt)}</div>
      </div>
      <div class="hdet2">${t.cat} ¬∑ <span class="txitem-kasa ${kasaCls}">${kasaLbl}</span></div>
      ${t.note?`<div class="hnote2">${t.note}</div>`:''}
      <div class="hact"><button class="hbtn hbtn-del" onclick="deleteTx(${i})">üóëÔ∏è Smazat</button></div>
    </div>`;
  }).join('');
}

async function deleteTx(i) {
  if (!confirm('Smazat tuto transakci?')) return;
  const h = gh();
  const t = h[i];
  if (t._id && window.deleteFromFirebase) {
    await window.deleteFromFirebase(t._id);
  } else {
    h.splice(i,1);
    localStorage.setItem('pk_hist', JSON.stringify(h));
    refreshAll();
  }
  toast('üóëÔ∏è Transakce smaz√°na');
}

// STATS
let statDays = 0;
function openStats() { statDays=0; renderStats(); document.getElementById('screen-stats').classList.add('open'); }
function setPeriod(days, btn) {
  statDays=days;
  document.querySelectorAll('.ptab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderStats();
}

function filterTx(days) {
  const h = gh();
  if (days===0) { const t=new Date();t.setHours(0,0,0,0);return h.filter(r=>new Date(r.ts)>=t); }
  return h.filter(r=>new Date(r.ts)>=new Date(Date.now()-days*86400000));
}

function renderStats() {
  const h = filterTx(statDays);
  const inc = h.filter(t=>t.typ==='income').reduce((s,t)=>s+t.amt,0);
  const exp = h.filter(t=>t.typ==='expense').reduce((s,t)=>s+t.amt,0);
  const offExp = h.filter(t=>t.typ==='expense'&&t.kasa==='official').reduce((s,t)=>s+t.amt,0);
  const unoffExp = h.filter(t=>t.typ==='expense'&&t.kasa==='unofficial').reduce((s,t)=>s+t.amt,0);

  document.getElementById('scards').innerHTML = `
    <div class="sc wide">
      <div class="sclbl">Celkov√© saldo</div>
      <div class="scval" style="color:${inc-exp>=0?'var(--green)':'var(--red)'}">${fkc(inc-exp)}</div>
      <div class="scsub">P≈ô√≠jmy: ${fkc(inc)} / V√Ωdaje: ${fkc(exp)}</div>
    </div>
    <div class="sc" style="background:var(--official-bg);border-color:var(--official-dim)">
      <div class="sclbl" style="color:var(--official)">V√Ωdaje ofiko</div>
      <div class="scval" style="color:var(--official)">${fkc(offExp)}</div>
      <div class="scsub">z ofic√°ln√≠ch penƒõz</div>
    </div>
    <div class="sc" style="background:var(--unofficial-bg);border-color:var(--unofficial-dim)">
      <div class="sclbl" style="color:var(--unofficial)">V√Ωdaje neofiko</div>
      <div class="scval" style="color:var(--unofficial)">${fkc(unoffExp)}</div>
      <div class="scsub">z neofic√°ln√≠ch penƒõz</div>
    </div>`;

  // Category breakdown
  const catMap = {};
  h.filter(t=>t.typ==='expense').forEach(t => {
    if (!catMap[t.cat]) catMap[t.cat]=0;
    catMap[t.cat]+=t.amt;
  });
  const sorted = Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const maxAmt = sorted.length>0?sorted[0][1]:1;
  document.getElementById('catlist').innerHTML = sorted.length===0
    ? '<div class="empty">≈Ω√°dn√© v√Ωdaje pro toto obdob√≠.</div>'
    : sorted.map(([name,amt])=>`
      <div class="catrow">
        <div class="catrow-name">${name}</div>
        <div class="catrow-bar"><div class="catrow-fill" style="width:${Math.round(amt/maxAmt*100)}%"></div></div>
        <div class="catrow-amt">${fkc(amt)}</div>
      </div>`).join('');
}

function toast(msg) {
  const t = document.getElementById('toast'); t.textContent=msg;
  t.classList.add('on'); setTimeout(()=>t.classList.remove('on'),2600);
}

refreshAll();
</script>
</body>
</html>
